<script src="jquery-3.5.1.min.js"></script>
<textarea id="cked4_editor">%(CONTENT)s</textarea>

<script> 
function ISODateString(d) {
    function pad(n) {return n<10 ? '0'+n : n}
    return d.getFullYear()+'-'
        + pad(d.getMonth()+1)+'-'
        + pad(d.getDate())+'_'
        + pad(d.getHours())+':'
        + pad(d.getMinutes())+':'
        + pad(d.getSeconds())
}

// var CKEDITOR_BASEPATH =  '%(BASEURL)s';  // '../../'   // '../../../../'   // '../../../';  // doesn't work


// TODO cleanup
CKEDITOR.replace( 'cked4_editor', {
            on: {
            instanceReady: function( evt ) {
                        evt.editor.execCommand('maximize');
                        this.document.appendStyleSheet( '../ckeditor4.css' );
                    },
            // TODO cleanup
            key: function( event ) {
                    var styles = [];
                    this.getStylesSet( function( defs ) { styles = defs } );
                    
                    // CTRL+Y
                    if ( event.data.keyCode == CKEDITOR.CTRL + 89 ) {
                        let now = ISODateString(new Date());
                        let content = event.editor.getData();
                        let blob = new Blob([content], {type: "text/plain;charset=utf-8"});
                        saveAs(blob, now + ".html");
                    }
                    
                    // Alt + Q
                    if ( event.data.keyCode == CKEDITOR.CTRL + 81 ) {
                            this.fire( 'saveSnapshot' );
                            var styleMarkerYellow = new CKEDITOR.style( {
                                    element: 'span', styles: { 'background-color': 'Yellow' }
                                } ),
                            elementPath = this.elementPath();
                        this[ styleMarkerYellow.checkActive( elementPath ) ? 'removeStyle' : 'applyStyle' ]( styleMarkerYellow );
                        this.fire( 'saveSnapshot' );
                        }
                    
                    // Alt + w
                    if ( event.data.keyCode == CKEDITOR.ALT + 87 ) {       
                            this.fire( 'saveSnapshot' );
                            var styleMarkerGreen = new CKEDITOR.style( {
                                    element: 'span', styles: { 'background-color': '#00FF00' }
                                } ),
                            elementPath = this.elementPath();
                        this[ styleMarkerGreen.checkActive( elementPath ) ? 'removeStyle' : 'applyStyle' ]( styleMarkerGreen );
                        this.fire( 'saveSnapshot' );
                        } 
                    
                    // Alt + e
                    if ( event.data.keyCode == CKEDITOR.ALT + 69 ) {       
                            this.fire( 'saveSnapshot' );
                            var styleMarkerRed = new CKEDITOR.style( {
                                    element: 'span', styles: { 'background-color': '#FF00FF' }
                                } ),
                            elementPath = this.elementPath();
                        this[ styleMarkerRed.checkActive( elementPath ) ? 'removeStyle' : 'applyStyle' ]( styleMarkerRed );
                        this.fire( 'saveSnapshot' );
                        }
                    
                    // Alt + r
                    if ( event.data.keyCode == CKEDITOR.ALT + 82 ) {       
                            this.fire( 'saveSnapshot' );
                            var styleMarkerCyan = new CKEDITOR.style( {
                                    element: 'span', styles: { 'background-color': '#00FFFF' }
                                } ),
                            elementPath = this.elementPath();
                        this[ styleMarkerCyan.checkActive( elementPath ) ? 'removeStyle' : 'applyStyle' ]( styleMarkerCyan );
                        this.fire( 'saveSnapshot' );
                        } 
                }
            }
    } );


// https://stackoverflow.com/a/11400271
CKEDITOR.on('instanceReady', function(e) {
// First time
e.editor.document.getBody().setStyle('background-color', '%(CUSTOMBGCOLOR)s');
e.editor.document.getBody().setStyle('color', '%(CUSTOMCOLOR)s');
// doesn't work for font name and font size
//e.editor.document.getBody().setStyle('font-family:', '%(FONTNAME)s');
//e.editor.document.getBody().setStyle('font-size:', '%(FONTSIZE)spx');
// in case the user switches to source and back
e.editor.on('contentDom', function() {
    e.editor.document.getBody().setStyle('background-color', '%(CUSTOMBGCOLOR)s');
    e.editor.document.getBody().setStyle('color', '%(CUSTOMCOLOR)s');
    //e.editor.document.getBody().setStyle('font-family:', '%(FONTNAME)s');
    //e.editor.document.getBody().setStyle('font-size:', '%(FONTSIZE)spx');
});
});


// https://stackoverflow.com/a/55144885
CKEDITOR.addCss(".cke_editable{cursor:text; font-size: %(FONTSIZE)spx; font-family: %(FONTNAME)s, sans-serif;}");



CKEDITOR.config.baseHref =  '%(BASEURL)s';
// CKEDITOR.config.baseHref =  '../../../../../';     // '../../';     // '../../../';    // '../../../../';  // all of these don't work



CKEDITOR.config.skin = '%(SKIN)s';


CKEDITOR.config.removePlugins = 'contextmenu';

CKEDITOR.editorConfig = function( config ) {
	config.language = 'en';
};

CKEDITOR.config.extraPlugins = 'indentblock';
CKEDITOR.config.extraPlugins = 'indent';

// activates spell checker from browser, might need to install hunspell package in firefox
CKEDITOR.config.disableNativeSpellChecker = true;


// hide status bar named Elements Path
// c.f. http://drupal.stackexchange.com/questions/62406/how-to-remove-the-status-bar-from-ckeditor
CKEDITOR.config.removePlugins = 'elementspath';
CKEDITOR.config.resize_enabled = false;



		
// plugin from https://github.com/w8tcha/CKEditor-TextSelection-Plugin
// found http://ckeditor.com/comment/123133#comment-123133
// when switching to source move cursor to correct position
CKEDITOR.config.extraPlugins = 'textselection';

// CKEDITOR.config.wordcount = {showWordCount: true}; // no effect in 2019-02


//  http://docs.ckeditor.com/#!/api/CKEDITOR.config-cfg-specialChars
//CKEDITOR.config.specialChars = [ '&mdash;', '&rsquo;', [ '&custom;', 'Custom label' ] ];
//CKEDITOR.config.specialChars = [ '&mdash;', '&rarr;' ];
CKEDITOR.config.specialChars = [ '&mdash;', '&rarr;', '&iexcl;', '&cent;', '&pound;', '&curren;', '&yen;', '&brvbar;', '&sect;', '&uml;', '&copy;', '&ordf;', '&laquo;', '&not;', '&reg;', '&macr;', '&deg;', '&sup2;', '&sup3;', '&acute;', '&micro;', '&para;', '&middot;', '&cedil;', '&sup1;', '&ordm;', '&raquo;', '&frac14;', '&frac12;', '&frac34;', '&iquest;', '&Agrave;', '&Aacute;', '&Acirc;', '&Atilde;', '&Auml;', '&Aring;', '&AElig;', '&Ccedil;', '&Egrave;', '&Eacute;', '&Ecirc;', '&Euml;', '&Igrave;', '&Iacute;', '&Icirc;', '&Iuml;', '&ETH;', '&Ntilde;', '&Ograve;', '&Oacute;', '&Ocirc;', '&Otilde;', '&Ouml;', '&times;', '&Oslash;', '&Ugrave;', '&Uacute;', '&Ucirc;', '&Uuml;', '&Yacute;', '&THORN;', '&szlig;', '&agrave;', '&aacute;', '&acirc;', '&atilde;', '&auml;', '&aring;', '&aelig;', '&ccedil;', '&egrave;', '&eacute;', '&ecirc;', '&euml;', '&igrave;', '&iacute;', '&icirc;', '&iuml;', '&eth;', '&ntilde;', '&ograve;', '&oacute;', '&ocirc;', '&otilde;', '&ouml;', '&divide;', '&oslash;', '&ugrave;', '&uacute;', '&ucirc;', '&uuml;', '&yacute;', '&thorn;', '&yuml;', '&OElig;', '&oelig;', '&#372;', '&#374', '&#373', '&#375;', '&sbquo;', '&#8219;', '&bdquo;', '&hellip;', '&trade;', '&#9658;', '&bull;', '&rarr;', '&hArr;', '&diams;', '&ndash;' ,'&asymp;' ]






//https://github.com/xiidea/ckeditor-easykeymap-plugin  
//keymap plugin needs wysiwygarea
CKEDITOR.config.extraPlugins = 'wysiwygarea';


//http://stackoverflow.com/questions/11949878/adding-fonts-available-in-ckeditor
CKEDITOR.editorConfig = function( config )
{
    config.font_names =
            'Times New Roman/Times New Roman, Times, serif;' +
	        'Droid Sans Mono, monospace;' +
	        'Arial/Arial, Helvetica, sans-serif;' +
	        //'Comic Sans MS/Comic Sans MS, cursive;' +
            'Courier New/Courier New, Courier, monospace;' +
            'Georgia/Georgia, serif;' +
            'Lucida Sans Unicode/Lucida Sans Unicode, Lucida Grande, sans-serif;' +
            'Tahoma/Tahoma, Geneva, sans-serif;' +
            'Trebuchet MS/Trebuchet MS, Helvetica, sans-serif;' +
            'Calibri/Calibri, Verdana, Geneva, sans-serif;' + /* here is your font */
            'Verdana/Verdana, Geneva, sans-serif';
};


// vgl. http://en.wikipedia.org/wiki/ASCII#ASCII_printable_characters
CKEDITOR.config.keystrokes = [
	[ CKEDITOR.CTRL + 77 /*M*/, 'indent' ],
	[ CKEDITOR.CTRL + CKEDITOR.SHIFT + 77 /*M*/, 'outdent' ],
	[ CKEDITOR.CTRL + 74 /*J*/, 'superscript' ],
	[ CKEDITOR.CTRL + 75 /*K*/, 'subscript' ],
	[ CKEDITOR.CTRL + 72 /*H*/, 'source' ],
	[ CKEDITOR.CTRL + CKEDITOR.SHIFT + 78 /*N*/, 'source' ],
	[ CKEDITOR.CTRL + CKEDITOR.SHIFT + 81 /*Q*/, 'source' ],
	[ CKEDITOR.CTRL + CKEDITOR.SHIFT + 76 /*L*/, 'link' ],
];



CKEDITOR.config.toolbar = [
	{ name: 'document', groups: [ 'mode', 'document', 'doctools' ], items: [ 'Source' ] },
	{ name: 'clipboard', groups: [ 'clipboard', 'undo' ], items: [ 'PasteFromWord', '-', 'Undo', 'Redo' ] },
	{ name: 'editing', groups: [ 'find', 'selection', 'spellchecker' ], items: [ 'Replace' ] },
	{ name: 'paragraph', groups: [ 'list', 'indent', 'blocks', 'align', 'bidi' ], items: [ 'NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'CreateDiv', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyBlock', '-', 'BidiLtr' ] },
	{ name: 'links', items: [ 'Link', 'Unlink', 'Anchor' ] },
	{ name: 'insert', items: [ 'Image', 'Table', 'SpecialChar' ] }, 
'/',
	{ name: 'basicstyles', groups: [ 'basicstyles', 'cleanup' ], items: [ 'Bold', 'Italic', 'Underline', 'Strike', 'Superscript', 'Subscript', '-', 'RemoveFormat' ] },
	{ name: 'styles', items: [ 'Styles', 'Format', 'Font', 'FontSize' ] },
	{ name: 'colors', items: [ 'TextColor', 'BGColor' ] },
	{ name: 'tools', items: [ 'Maximize' ] },
	{ name: 'others', items: [ '-' ] }
];



CKEDITOR.stylesSet.add( 'default', [
	/* Block Styles */

	// These styles are already available in the "Format" combo ("format" plugin),
	// so they are not needed here by default. You may enable them to avoid
	// placing the "Format" combo in the toolbar, maintaining the same features.
	/*
	{ name: 'Paragraph',		element: 'p' },
	{ name: 'Heading 1',		element: 'h1' },
	{ name: 'Heading 2',		element: 'h2' },
	{ name: 'Heading 3',		element: 'h3' },
	{ name: 'Heading 4',		element: 'h4' },
	{ name: 'Heading 5',		element: 'h5' },
	{ name: 'Heading 6',		element: 'h6' },
	{ name: 'Preformatted Text',element: 'pre' },
	{ name: 'Address',			element: 'address' },
	*/

	// { name: 'Italic Title',		element: 'h2', styles: { 'font-style': 'italic' } },
	// { name: 'Subtitle',			element: 'h3', styles: { 'color': '#aaa', 'font-style': 'italic' } },
	/* {
		name: 'Special Container',
		element: 'div',
		styles: {
			padding: '5px 10px',
			background: '#eee',
			border: '1px solid #ccc'
		}
	},
	*/

	/* Inline Styles */

	// These are core styles available as toolbar buttons. You may opt enabling
	// some of them in the Styles combo, removing them from the toolbar.
	// (This requires the "stylescombo" plugin)
	/*
	{ name: 'Strong',			element: 'strong', overrides: 'b' },
	{ name: 'Emphasis',			element: 'em'	, overrides: 'i' },
	{ name: 'Underline',		element: 'u' },
	{ name: 'Strikethrough',	element: 'strike' },
	{ name: 'Subscript',		element: 'sub' },
	{ name: 'Superscript',		element: 'sup' },
	*/

	/*{ name: 'Yellow',			element: 'span', attributes: { 'class': 'marker' } },*/
	/*  { name: 'CSS Style', element: 'span', attributes: { 'class': 'my_style' } }, */
	
	
	{ name: 'MarkerYellow',	element: 'span', styles: { 'background-color': 'Yellow' } },
	{ name: 'MarkerGreen',  element: 'span', styles: { 'background-color': '#00FF00' } },
	{ name: 'MarkerRed',    element: 'span', styles: { 'background-color': '#FF00FF' } },
	{ name: 'MarkerCyan',   element: 'span', styles: { 'background-color': '#00FFFF' } },
	
	
	// { name: 'Big',				element: 'big' },
	// { name: 'Small',			element: 'small' },
	{ name: 'Typewriter',		element: 'tt' },

	{ name: 'Computer Code',	element: 'code' },
	// { name: 'Keyboard Phrase',	element: 'kbd' },
	// { name: 'Sample Text',		element: 'samp' },
	//{ name: 'Variable',			element: 'var' },

	{ name: 'Deleted Text',		element: 'del' },
	{ name: 'Inserted Text',	element: 'ins' },

	{ name: 'Cited Work',		element: 'cite' },
	{ name: 'Inline Quotation',	element: 'q' },

	//{ name: 'Language: RTL',	element: 'span', attributes: { 'dir': 'rtl' } },
	//{ name: 'Language: LTR',	element: 'span', attributes: { 'dir': 'ltr' } },

	/* Object Styles */

	{
		name: 'Styled image (left)',
		element: 'img',
		attributes: { 'class': 'left' }
	},

	{
		name: 'Styled image (right)',
		element: 'img',
		attributes: { 'class': 'right' }
	},

	{
		name: 'Compact table',
		element: 'table',
		attributes: {
			cellpadding: '5',
			cellspacing: '0',
			border: '1',
			bordercolor: '#ccc'
		},
		styles: {
			'border-collapse': 'collapse'
		}
	},

	{ name: 'Borderless Table',		element: 'table',	styles: { 'border-style': 'hidden', 'background-color': '#E6E6FA' } },
	{ name: 'Square Bulleted List',	element: 'ul',		styles: { 'list-style-type': 'square' } }
] );
</script>


